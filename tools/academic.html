<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latex Tools</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX for rendering math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Literata:opsz,wght@7..72,400;7..72,600&family=Inter:wght@400;600&display=swap');
        :root {
            --bg: #f6f8fc;
            --surface: #ffffff;
            --text: #0f172a;
            --muted: #475569;
            --border: #e5e7eb;
            --accent-50: #eef2ff;
            --accent-100: #dbeafe;
            --accent-200: #a7c9f1;
            --accent-500: #3b82f6;
            --accent-600: #2563eb;
            --accent-800: #1e3a8a;
        }
        body {
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            overflow-y: auto;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .katex-display {
            margin: 0 !important;
        }
        textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-200);
        }
        .preview-box {
            background-image: radial-gradient(var(--accent-100) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        header .flex.items-center.justify-between {
            gap: 0.5rem;
        }
        @media (max-width: 640px) {
            header .flex.items-center.justify-between {
                flex-direction: column;
                align-items: flex-start;
                height: auto;
                gap: 0.75rem;
            }
            main { padding: 1rem !important; }
        }
        ::selection {
            background: var(--accent-200);
            color: var(--text);
        }
        /* Palette overrides for Tailwind utility classes to keep colors centralized */
        .bg-blue-50 { background-color: var(--accent-50) !important; }
        .bg-blue-100 { background-color: var(--accent-100) !important; }
        .bg-blue-200 { background-color: var(--accent-200) !important; }
        .bg-blue-500 { background-color: var(--accent-500) !important; }
        .bg-blue-600 { background-color: var(--accent-600) !important; }
        .bg-blue-800 { background-color: var(--accent-800) !important; }
        .text-blue-800 { color: var(--accent-800) !important; }
        .border-blue-200 { border-color: var(--accent-200) !important; }
        .border-blue-500 { border-color: var(--accent-500) !important; }
        .border-blue-600 { border-color: var(--accent-600) !important; }
        .focus\:border-blue-500:focus { border-color: var(--accent-500) !important; }
        .hover\:bg-blue-100:hover { background-color: var(--accent-100) !important; }
        .hover\:bg-blue-200:hover { background-color: var(--accent-200) !important; }
        .hover\:bg-blue-500:hover { background-color: var(--accent-500) !important; }
        .hover\:bg-blue-600:hover { background-color: var(--accent-600) !important; }
        .selection\:bg-blue-200\/50::selection { background-color: rgba(191, 219, 254, 0.274) !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // DATA: LaTeX Symbols
        // ==========================================
        const symbolData = [
            // Greek Letters
            { id: 'alpha', command: '\\alpha', category: 'Greek', keywords: ['a', 'lower'] },
            { id: 'beta', command: '\\beta', category: 'Greek', keywords: ['b', 'lower'] },
            { id: 'gamma', command: '\\gamma', category: 'Greek', keywords: ['g', 'lower'] },
            { id: 'delta', command: '\\delta', category: 'Greek', keywords: ['d', 'change', 'lower'] },
            { id: 'epsilon', command: '\\epsilon', category: 'Greek', keywords: ['e', 'lower'] },
            { id: 'varepsilon', command: '\\varepsilon', category: 'Greek', keywords: ['e', 'variant', 'lower'] },
            { id: 'zeta', command: '\\zeta', category: 'Greek', keywords: ['z', 'lower'] },
            { id: 'eta', command: '\\eta', category: 'Greek', keywords: ['h', 'lower'] },
            { id: 'theta', command: '\\theta', category: 'Greek', keywords: ['th', 'angle', 'lower'] },
            { id: 'vartheta', command: '\\vartheta', category: 'Greek', keywords: ['th', 'variant', 'angle', 'lower'] },
            { id: 'iota', command: '\\iota', category: 'Greek', keywords: ['i', 'lower'] },
            { id: 'kappa', command: '\\kappa', category: 'Greek', keywords: ['k', 'lower'] },
            { id: 'lambda', command: '\\lambda', category: 'Greek', keywords: ['l', 'lower'] },
            { id: 'mu', command: '\\mu', category: 'Greek', keywords: ['m', 'micro', 'lower'] },
            { id: 'nu', command: '\\nu', category: 'Greek', keywords: ['n', 'lower'] },
            { id: 'xi', command: '\\xi', category: 'Greek', keywords: ['x', 'lower'] },
            { id: 'pi', command: '\\pi', category: 'Greek', keywords: ['p', 'circle', 'lower'] },
            { id: 'rho', command: '\\rho', category: 'Greek', keywords: ['r', 'lower'] },
            { id: 'varrho', command: '\\varrho', category: 'Greek', keywords: ['r', 'variant', 'lower'] },
            { id: 'sigma', command: '\\sigma', category: 'Greek', keywords: ['s', 'sum', 'lower'] },
            { id: 'phi', command: '\\phi', category: 'Greek', keywords: ['f', 'golden', 'lower'] },
            { id: 'varphi', command: '\\varphi', category: 'Greek', keywords: ['f', 'variant', 'lower'] },
            { id: 'psi', command: '\\psi', category: 'Greek', keywords: ['ps', 'wave', 'lower'] },
            { id: 'omega', command: '\\omega', category: 'Greek', keywords: ['o', 'w', 'lower'] },
            { id: 'varsigma', command: '\\varsigma', category: 'Greek', keywords: ['s', 'terminal', 'lower'] },
            { id: 'tau', command: '\\tau', category: 'Greek', keywords: ['t', 'lower'] },
            { id: 'upsilon', command: '\\upsilon', category: 'Greek', keywords: ['u', 'y', 'lower'] },
            { id: 'chi', command: '\\chi', category: 'Greek', keywords: ['x', 'chi', 'lower'] },
            { id: 'Gamma', command: '\\Gamma', category: 'Greek', keywords: ['G', 'upper'] },
            { id: 'Delta', command: '\\Delta', category: 'Greek', keywords: ['D', 'upper', 'change'] },
            { id: 'Theta', command: '\\Theta', category: 'Greek', keywords: ['TH', 'upper'] },
            { id: 'Lambda', command: '\\Lambda', category: 'Greek', keywords: ['L', 'upper'] },
            { id: 'Pi', command: '\\Pi', category: 'Greek', keywords: ['P', 'product', 'upper'] },
            { id: 'Sigma', command: '\\Sigma', category: 'Greek', keywords: ['S', 'summation', 'upper'] },
            { id: 'Phi', command: '\\Phi', category: 'Greek', keywords: ['F', 'upper'] },
            { id: 'Omega', command: '\\Omega', category: 'Greek', keywords: ['O', 'ohms', 'upper'] },
            { id: 'Epsilon', command: '\\Epsilon', category: 'Greek', keywords: ['E', 'upper'] },
            { id: 'Zeta', command: '\\Zeta', category: 'Greek', keywords: ['Z', 'upper'] },
            { id: 'Eta', command: '\\Eta', category: 'Greek', keywords: ['H', 'upper'] },
            { id: 'Iota', command: '\\Iota', category: 'Greek', keywords: ['I', 'upper'] },
            { id: 'Kappa', command: '\\Kappa', category: 'Greek', keywords: ['K', 'upper'] },
            { id: 'Nu', command: '\\Nu', category: 'Greek', keywords: ['N', 'upper'] },
            { id: 'Xi', command: '\\Xi', category: 'Greek', keywords: ['X', 'upper'] },
            { id: 'Rho', command: '\\Rho', category: 'Greek', keywords: ['R', 'upper'] },
            { id: 'Tau', command: '\\Tau', category: 'Greek', keywords: ['T', 'upper'] },
            { id: 'Upsilon', command: '\\Upsilon', category: 'Greek', keywords: ['U', 'Y', 'upper'] },
            { id: 'Chi', command: '\\Chi', category: 'Greek', keywords: ['X', 'upper'] },

            // Operators & Big Ops
            { id: 'times', command: '\\times', category: 'Operators', keywords: ['multiply', 'cross', 'x'] },
            { id: 'cdot', command: '\\cdot', category: 'Operators', keywords: ['dot', 'multiply'] },
            { id: 'div', command: '\\div', category: 'Operators', keywords: ['divide', 'division'] },
            { id: 'pm', command: '\\pm', category: 'Operators', keywords: ['plus', 'minus'] },
            { id: 'sum', command: '\\sum', category: 'Operators', keywords: ['summation', 'add'] },
            { id: 'prod', command: '\\prod', category: 'Operators', keywords: ['product', 'pi'] },
            { id: 'int', command: '\\int', category: 'Operators', keywords: ['integral', 'calculus'] },
            { id: 'oint', command: '\\oint', category: 'Operators', keywords: ['contour', 'integral'] },
            { id: 'frac', command: '\\frac{a}{b}', copy: '\\frac{}{}', category: 'Operators', keywords: ['fraction', 'division'] },
            { id: 'sqrt', command: '\\sqrt{x}', copy: '\\sqrt{}', category: 'Operators', keywords: ['square', 'root'] },
            { id: 'lim', command: '\\lim_{x \\to 0}', copy: '\\lim_{ \\to }', category: 'Operators', keywords: ['limit'] },

            // Matrices & Structures
            { id: 'matrix', command: '\\begin{matrix} a & b \\\\ c & d \\end{matrix}', copy: '\\begin{matrix}  &  \\\\\\\\  &  \\end{matrix}', category: 'Matrices', keywords: ['plain', 'matrix'] },
            { id: 'pmatrix', command: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}', copy: '\\begin{pmatrix}  &  \\\\\\\\  &  \\end{pmatrix}', category: 'Matrices', keywords: ['paren', 'matrix'] },
            { id: 'bmatrix', command: '\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}', copy: '\\begin{bmatrix}  &  \\\\\\\\  &  \\end{bmatrix}', category: 'Matrices', keywords: ['bracket', 'matrix'] },
            { id: 'vmatrix', command: '\\begin{vmatrix} a & b \\\\ c & d \\end{vmatrix}', copy: '\\begin{vmatrix}  &  \\\\\\\\  &  \\end{vmatrix}', category: 'Matrices', keywords: ['determinant', 'matrix'] },
            { id: 'smallmatrix', command: '\\begin{smallmatrix} a & b \\\\ c & d \\end{smallmatrix}', copy: '\\begin{smallmatrix}  &  \\\\\\\\  &  \\end{smallmatrix}', category: 'Matrices', keywords: ['inline', 'matrix'] },

            // Relations
            { id: 'leq', command: '\\leq', category: 'Relations', keywords: ['less', 'equal'] },
            { id: 'geq', command: '\\geq', category: 'Relations', keywords: ['greater', 'equal'] },
            { id: 'neq', command: '\\neq', category: 'Relations', keywords: ['not', 'equal'] },
            { id: 'approx', command: '\\approx', category: 'Relations', keywords: ['approximate'] },
            { id: 'equiv', command: '\\equiv', category: 'Relations', keywords: ['equivalent'] },
            { id: 'sim', command: '\\sim', category: 'Relations', keywords: ['similar'] },
            { id: 'subset', command: '\\subset', category: 'Relations', keywords: ['set', 'contained'] },
            { id: 'subseteq', command: '\\subseteq', category: 'Relations', keywords: ['subset', 'equal'] },
            { id: 'supset', command: '\\supset', category: 'Relations', keywords: ['superset'] },
            { id: 'supseteq', command: '\\supseteq', category: 'Relations', keywords: ['superset', 'equal'] },
            { id: 'in', command: '\\in', category: 'Relations', keywords: ['element', 'set'] },
            { id: 'notin', command: '\\notin', category: 'Relations', keywords: ['not', 'element'] },

            // Arrows
            { id: 'leftarrow', command: '\\leftarrow', category: 'Arrows', keywords: ['left'] },
            { id: 'rightarrow', command: '\\rightarrow', category: 'Arrows', keywords: ['right', 'to', 'implies'] },
            { id: 'leftrightarrow', command: '\\leftrightarrow', category: 'Arrows', keywords: ['both'] },
            { id: 'Rightarrow', command: '\\Rightarrow', category: 'Arrows', keywords: ['double', 'right', 'implies'] },
            { id: 'Leftrightarrow', command: '\\Leftrightarrow', category: 'Arrows', keywords: ['double', 'iff'] },
            { id: 'mapsto', command: '\\mapsto', category: 'Arrows', keywords: ['maps', 'function'] },

            // Logic & Misc
            { id: 'forall', command: '\\forall', category: 'Logic', keywords: ['all', 'every', 'universal'] },
            { id: 'exists', command: '\\exists', category: 'Logic', keywords: ['existential'] },
            { id: 'infty', command: '\\infty', category: 'Misc', keywords: ['infinity'] },
            { id: 'partial', command: '\\partial', category: 'Misc', keywords: ['derivative'] },
            { id: 'nabla', command: '\\nabla', category: 'Misc', keywords: ['del', 'gradient'] },
            { id: 'angle', command: '\\angle', category: 'Misc', keywords: ['geometry'] },
            { id: 'therefore', command: '\\therefore', category: 'Logic', keywords: ['conclusion'] },
            { id: 'emptyset', command: '\\emptyset', category: 'Logic', keywords: ['null', 'set'] },
            { id: 'cdots', command: '\\cdots', category: 'Misc', keywords: ['dots', 'ellipsis', 'center'] },
            { id: 'ldots', command: '\\ldots', category: 'Misc', keywords: ['dots', 'ellipsis', 'lower'] },

            // Sets & Blackboard
            { id: 'mathbbR', command: '\\mathbb{R}', category: 'Sets', keywords: ['real', 'reals', 'blackboard'] },
            { id: 'mathbbN', command: '\\mathbb{N}', category: 'Sets', keywords: ['natural', 'naturals', 'blackboard'] },
            { id: 'mathbbZ', command: '\\mathbb{Z}', category: 'Sets', keywords: ['integer', 'integers', 'blackboard'] },
            { id: 'mathbbQ', command: '\\mathbb{Q}', category: 'Sets', keywords: ['rational', 'rationals', 'blackboard'] },
            { id: 'mathbbC', command: '\\mathbb{C}', category: 'Sets', keywords: ['complex', 'complexes', 'blackboard'] },
            
            // Accents
            { id: 'hat', command: '\\hat{a}', copy: '\\hat{}', category: 'Accents', keywords: ['unit', 'vector'] },
            { id: 'bar', command: '\\bar{a}', copy: '\\bar{}', category: 'Accents', keywords: ['mean', 'average'] },
            { id: 'vec', command: '\\vec{a}', copy: '\\vec{}', category: 'Accents', keywords: ['vector'] },
            { id: 'dot', command: '\\dot{a}', copy: '\\dot{}', category: 'Accents', keywords: ['derivative'] },
            
            // Delimiters
            { id: 'lb', command: '\\{', category: 'Delimiters', keywords: ['brace', 'curly'] },
            { id: 'rb', command: '\\}', category: 'Delimiters', keywords: ['brace', 'curly'] },
            { id: 'langle', command: '\\langle', category: 'Delimiters', keywords: ['angle', 'bracket'] },
            { id: 'rangle', command: '\\rangle', category: 'Delimiters', keywords: ['angle', 'bracket'] },
            { id: 'lceil', command: '\\lceil', category: 'Delimiters', keywords: ['ceil', 'ceiling'] },
            { id: 'rceil', command: '\\rceil', category: 'Delimiters', keywords: ['ceil', 'ceiling'] },
            { id: 'lfloor', command: '\\lfloor', category: 'Delimiters', keywords: ['floor'] },
            { id: 'rfloor', command: '\\rfloor', category: 'Delimiters', keywords: ['floor'] },
            { id: 'ell', command: '\\ell', category: 'Misc', keywords: ['l', 'cursive'] },
            { id: 'hbar', command: '\\hbar', category: 'Misc', keywords: ['h', 'physics'] },
        ];

        // ==========================================
        // HELPERS
        // ==========================================
        const copyToClipboard = (text, callback) => {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => callback("Copied to clipboard!"));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    callback("Copied to clipboard!");
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    callback("Failed to copy");
                }
                document.body.removeChild(textArea);
            }
        };

        const capitalize = (word) => word.charAt(0).toUpperCase() + word.slice(1);

        // ==========================================
        // COMPONENTS
        // ==========================================

        const LatexRenderer = ({ latex, className = "", displayMode = true, style = {} }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && window.katex) {
                    try {
                        window.katex.render(latex, containerRef.current, {
                            throwOnError: false,
                            displayMode, 
                            output: 'html'
                        });
                    } catch (e) {}
                }
            }, [latex]);
            return (
                <div
                    ref={containerRef}
                    className={`text-xl ${className}`}
                    style={{ maxWidth: '100%', maxHeight: '100%', overflow: 'hidden', ...style }}
                />
            );
        };

        const Toast = ({ message }) => (
            <div className={`fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg transition-all duration-300 z-50 flex items-center gap-2 ${message ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                <span className="font-medium">{message}</span>
            </div>
        );

        // --- SUB-APP: Equation Editor ---
        const EquationEditor = ({ showToast }) => {
            const [latexInput, setLatexInput] = useState('\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}');
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const textareaRef = useRef(null);

            const categories = useMemo(() => ['All', ...new Set(symbolData.map(s => s.category))], []);
            const filteredSymbols = useMemo(() => {
                const lowerSearch = searchTerm.toLowerCase();
                return symbolData.filter(symbol => {
                    if (selectedCategory !== 'All' && symbol.category !== selectedCategory) return false;
                    if (!lowerSearch) return true;
                    return symbol.command.toLowerCase().includes(lowerSearch) || 
                           symbol.keywords.some(k => k.toLowerCase().includes(lowerSearch));
                });
            }, [searchTerm, selectedCategory]);

            const handleInsert = (symbolCommand) => {
                const textarea = textareaRef.current;
                if (!textarea) return;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = latexInput;
                const newText = text.substring(0, start) + symbolCommand + text.substring(end);
                setLatexInput(newText);
                setTimeout(() => {
                    textarea.focus();
                    const newCursorPos = start + symbolCommand.length;
                    textarea.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            };

            const templates = [
                { label: 'Matrix', code: '\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}' },
                { label: 'Cases', code: '\\begin{cases} x & \\text{if } x > 0 \\\\ -x & \\text{if } x \\leq 0 \\end{cases}' },
                { label: 'Align', code: '\\begin{align*} a &= b \\\\ c &= d \\end{align*}' }
            ];

            return (
                <div className="flex flex-col h-full">
                    {/* Editor & Preview */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="flex flex-col gap-2">
                            <label className="text-xs font-bold text-blue-800 uppercase tracking-wider">LaTeX Source</label>
                            <textarea
                                ref={textareaRef}
                                value={latexInput}
                                onChange={(e) => setLatexInput(e.target.value)}
                                className="w-full h-40 bg-white text-stone-800 font-mono text-base p-4 rounded-lg border border-stone-300 shadow-inner resize-none placeholder-stone-400 focus:border-blue-500 transition-colors"
                                placeholder="Type LaTeX here..."
                                spellCheck="false"
                            />
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="text-xs font-bold text-blue-800 uppercase tracking-wider">Live Preview</label>
                            <div className="w-full h-40 bg-blue-20 text-stone-900 
                            rounded-lg border border-blue-200 flex items-center justify-center p-4 overflow-auto preview-box shadow-inner">
                                {latexInput.trim() ? <LatexRenderer latex={latexInput} /> : 
                                <span className="text-stone-400 italic">Preview...</span>}
                            </div>
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="flex justify-between mb-4 items-center">
                         <div className="flex gap-2">
                            {templates.map(t => (
                                <button 
                                    key={t.label}
                                    onClick={() => handleInsert(t.code)}
                                    className="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-xs text-blue-800 rounded border border-blue-200 font-medium"
                                >
                                    + {t.label}
                                </button>
                            ))}
                        </div>
                        <button 
                            onClick={() => copyToClipboard(latexInput, showToast)}
                            className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm flex items-center gap-2 shadow-sm"
                        >
                            Copy Source
                        </button>
                    </div>

                    {/* Toolbar */}
                    <div className="bg-white border-t border-stone-200 flex-1 -mx-2 px-2 pt-3 rounded-b-xl shadow-inner">
                        <div className="flex flex-col md:flex-row gap-3 mb-3">
                            <input
                                type="text"
                                placeholder="Search symbols..."
                                className="bg-white text-stone-800 border border-stone-300 rounded-lg py-1 px-2.5 focus:outline-none focus:border-blue-500 text-sm w-full md:w-56 shadow-sm"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            <div className="flex-1 flex flex-wrap gap-2 items-center">
                                {categories.map(cat => (
                                    <button
                                        key={cat}
                                        onClick={() => setSelectedCategory(cat)}
                                        className={`px-2.5 py-1 rounded-full text-[10px] 
                                            font-semibold uppercase tracking-wide 
                                            transition-colors border ${selectedCategory === cat ? 
                                            'bg-blue-600 text-white border-blue-600 shadow-sm' : 
                                            'bg-blue-50 text-blue-800 border-blue-100 hover:bg-blue-100'}`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Grid */}
                        <div className="h-[300px] overflow-y-auto pr-2 custom-scrollbar pb-6">
                            {filteredSymbols.length === 0 ? (
                                <div className="text-center py-10 text-stone-500">No symbols found.</div>
                            ) : (
                                <div className="grid grid-cols-12 sm:
                                grid-cols-16 md:grid-cols-20 lg:grid-cols-26 gap-[0.5rem]">
                                    {filteredSymbols.map((symbol) => {
                                        const compactStyle = symbol.category === 'Matrices'
                                            ? { maxWidth: '72px', overflow: 'hidden', fontSize: '10px', lineHeight: '1', transform: 'translateY(1px)' }
                                            : { lineHeight: '1', transform: 'translateY(1px)' };
                                        return (
                                            <button
                                                key={symbol.id}
                                                onClick={() => handleInsert(symbol.copy || symbol.command)}
                                                className="group flex items-center justify-center bg-blue-50 
                                                border border-blue-200 rounded px-1 py-[2px] h-9 hover:
                                                bg-blue-100 transition-all overflow-hidden"
                                                title={symbol.command}
                                            >
                                                <LatexRenderer
                                                    latex={symbol.command}
                                                    className="text-[10px] text-blue-800 pointer-events-none"
                                                    displayMode={false}
                                                    style={compactStyle}
                                                />
                                            </button>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- SUB-APP: Text Tools ---
        const TextTools = ({ showToast }) => {
            const [text, setText] = useState('');
            const [stats, setStats] = useState({ words: 0, chars: 0, sentences: 0, paragraphs: 0 });
            const textAreaRef = useRef(null);

            useEffect(() => {
                const charCount = text.length;
                const words = text.trim() === '' ? [] : text.trim().split(/\s+/);
                const sentences = text.trim() === '' ? [] : text.split(/[.!?]+/).filter(s => s.trim().length > 0);
                const paragraphs = text.trim() === '' ? [] : text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                
                setStats({
                    words: words.length,
                    chars: charCount,
                    sentences: sentences.length,
                    paragraphs: paragraphs.length
                });
            }, [text]);

            // Transform Functions
            const transform = (type) => {
                if (!text) return;
                let newText = text;

                if (type === 'upper') newText = text.toUpperCase();
                else if (type === 'lower') newText = text.toLowerCase();
                else if (type === 'sentence') {
                    newText = text.toLowerCase().replace(/(^\s*\w|[.!?]\s*\w)/g, c => c.toUpperCase());
                } else if (type === 'title_apa') {
                    const minorWords = new Set(['a', 'an', 'the', 'and', 'but', 'or', 'for', 'nor', 'on', 'at', 'to', 'from', 'by', 'with', 'in', 'of', 'up', 'out', 'as']);
                    newText = text.toLowerCase().split(/(\s+)/).map((word, index, arr) => {
                        if (index === 0 || index === arr.length - 1) return capitalize(word);
                        if (word.trim() === '') return word;
                        if (minorWords.has(word.toLowerCase())) {
                            const prev = index > 1 ? arr[index - 2].trim() : '';
                            if (prev && (prev.endsWith(':') || prev.endsWith('.') || prev.endsWith('?'))) return capitalize(word);
                            return word.toLowerCase();
                        }
                        return capitalize(word);
                    }).join('');
                }
                setText(newText);
                showToast(`Applied: ${type.replace('_', ' ')}`);
            };

            const formalize = () => {
                if (!text) return;
                const replacements = {
                    "can't": "cannot", "won't": "will not", "n't": " not", "'re": " are", 
                    "'m": " am", "'ll": " will", "'ve": " have", "it's": "it is", "he's": "he is",
                    "she's": "she is", "that's": "that is", "there's": "there is", "what's": "what is"
                };
                let newText = text;
                for (const [key, val] of Object.entries(replacements)) {
                    const regex = new RegExp(key, 'gi');
                    newText = newText.replace(regex, val);
                }
                setText(newText);
                showToast("Expanded contractions");
            };

            const cleanSpacing = () => {
                if (!text) return;
                let newText = text.replace(/[ \t]+/g, ' ').replace(/\s+([.,;!?])/g, '$1').replace(/([.,;!?])(?=[a-zA-Z])/g, '$1 ');
                setText(newText.trim());
                showToast("Cleaned whitespace");
            };

            const fixBrokenLines = () => {
                if (!text) return;
                // Merges lines where the first line does NOT end in punctuation.
                const newText = text.replace(/([^\n.!?])\n(?![ \n\r])/g, '$1 ');
                setText(newText);
                showToast("Fixed broken lines (PDF)");
            }

            const stripCitations = () => {
                if (!text) return;
                // Remove [1], [1-5], [1, 2] and (Author, 2000)
                let newText = text
                    .replace(/\[\d+(?:,\s*\d+|-\d+)*\]/g, '')
                    .replace(/\([A-Za-z\s]+,\s*\d{4}\)/g, '')
                    .replace(/  +/g, ' '); // cleanup extra spaces left behind
                setText(newText.trim());
                showToast("Removed citations");
            }

            const convertToLatex = () => {
                if (!text) return '';
                const escapes = {
                    '\\': '\\textbackslash ',
                    '&': '\\&',
                    '%': '\\%',
                    '$': '\\$',
                    '#': '\\#',
                    '_': '\\_',
                    '{': '\\{',
                    '}': '\\}',
                    '~': '\\textasciitilde ',
                    '^': '\\textasciicircum '
                };
                let newText = text.replace(/[\\&%\$#_{}~^]/g, match => escapes[match]);
                // convert newlines to LaTeX line breaks for readability
                newText = newText.replace(/\n{2,}/g, '\n\n').replace(/\n/g, '\\\\\n');
                setText(newText);
                showToast("Converted to LaTeX-safe text");
                return newText;
            };

            const preparePreview = (src) => {
                if (!src || !src.trim()) return '';
                const trimmed = src.trim();
                // If it already has LaTeX commands or math delimiters, render as-is.
                if (/[\\$]/.test(trimmed)) return trimmed;
                // Otherwise wrap in \text{} and escape braces/backslashes.
                const escaped = trimmed.replace(/([\\{}])/g, '\\$1');
                return `\\text{${escaped}}`;
            };

            const wrapSelection = (prefix, suffix, placeholder = 'text') => {
                const area = textAreaRef.current;
                if (!area) {
                    const inserted = `${prefix}${placeholder}${suffix}`;
                    setText(text + inserted);
                    return;
                }
                const start = area.selectionStart ?? 0;
                const end = area.selectionEnd ?? 0;
                const selected = text.slice(start, end) || placeholder;
                const newValue = text.slice(0, start) + prefix + selected + suffix + text.slice(end);
                setText(newValue);
                const newStart = start + prefix.length;
                const newEnd = newStart + selected.length;
                requestAnimationFrame(() => {
                    area.focus();
                    area.setSelectionRange(newStart, newEnd);
                });
            };

            const colorChoices = ['red', 'blue', 'magenta', 'gray'];
            const insertSection = (level) => {
                const base = level === 'section' ? 'Section Title' : level === 'subsection' ? 'Subsection Title' : 'Paragraph Title';
                const labelBase = level === 'section' ? 'sec' : level === 'subsection' ? 'subsec' : 'para';
                const safe = base.replace(/\s+/g, '_').toLowerCase();
                const snippet = `\\${level}{${base}}\\label{${labelBase}:${safe}}`;
                wrapSelection(`\\${level}{`, `}\\label{${labelBase}:${safe}}`, base);
                showToast(`Inserted ${level}`);
            };
            const [latexPreview, setLatexPreview] = useState('');

            return (
                <div className="flex flex-col h-full gap-4">
                    <div className="flex flex-col flex-1 relative">
                        <textarea
                            ref={textAreaRef}
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            placeholder="Paste your academic text or abstract here..."
                            className="flex-1 w-full bg-white text-stone-900 text-lg p-4 rounded-lg border border-stone-300 shadow-inner resize-none placeholder-stone-400 focus:border-blue-500 transition-colors leading-relaxed min-h-[360px]"
                            style={{ fontFamily: 'Literata, serif' }}
                            spellCheck="true"
                        />
                        <div className="absolute bottom-2 right-2 flex gap-4 text-xs text-stone-500 bg-blue-50/90 px-3 py-1 rounded-full backdrop-blur-sm border border-blue-200 shadow-sm">
                            <span>{stats.words} Words</span>
                            <span>{stats.chars} Chars</span>
                            <span>{stats.sentences} Sentences</span>
                            <span>{stats.paragraphs} Paras</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-4">
                        <div className="bg-white p-3 rounded-lg border border-stone-200 shadow-sm">
                            <label className="text-xs font-bold text-blue-800 uppercase tracking-wider mb-2 block">Case & Format</label>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => transform('title_apa')} className="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm text-blue-800 border border-blue-200">Title Case (APA)</button>
                                <button onClick={() => transform('sentence')} className="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm text-blue-800 border border-blue-200">Sentence Case</button>
                                <button onClick={() => transform('upper')} className="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm text-blue-800 border border-blue-200">UPPERCASE</button>
                                <button onClick={() => transform('lower')} className="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm text-blue-800 border border-blue-200">lowercase</button>
                            </div>
                        </div>
                        <div className="bg-white p-3 rounded-lg border border-stone-200 shadow-sm">
                            <label className="text-xs font-bold text-blue-800 uppercase tracking-wider mb-2 block">LaTeX Formatting</label>
                            <div className="flex flex-wrap gap-2 mb-2">
                                <button onClick={() => wrapSelection('\\textbf{', '}')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200 font-semibold">Bold</button>
                                <button onClick={() => wrapSelection('\\textit{', '}')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200 italic">Italic</button>
                                <button onClick={() => wrapSelection('\\texttt{', '}')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200">Monospace</button>
                                <button onClick={() => wrapSelection('$', '$', 'a+b')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200">Inline Math</button>
                                <button onClick={() => wrapSelection('$$\n', '\n$$', 'E=mc^2')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200">Display Math</button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {colorChoices.map((c) => (
                                    <button
                                        key={c}
                                        onClick={() => wrapSelection(`\\textcolor{${c}}{`, '}', 'text')}
                                        className="px-3 py-1.5 rounded text-sm border border-blue-200 text-blue-800 bg-blue-50 hover:bg-blue-100"
                                    >
                                        Color: {capitalize(c)}
                                    </button>
                                ))}
                            </div>
                            <div className="flex flex-wrap gap-2 mt-2">
                                <button onClick={() => insertSection('section')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200">Section + Label</button>
                                <button onClick={() => insertSection('subsection')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200">Subsection + Label</button>
                                <button onClick={() => insertSection('paragraph')} className="bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded text-sm text-blue-800 border border-blue-200">Paragraph + Label</button>
                            </div>
                            <div className="mt-3">
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={() => {
                                            const converted = convertToLatex();
                                            if (converted) setLatexPreview(converted);
                                        }}
                                        className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm"
                                    >
                                        Convert Text to LaTeX Mode
                                    </button>
                                    <button
                                        onClick={() => {
                                            const previewable = preparePreview(text);
                                            if (previewable) setLatexPreview(previewable);
                                        }}
                                        className="bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-2 rounded-lg text-sm font-medium border border-blue-200"
                                    >
                                        Preview LaTeX
                                    </button>
                                </div>
                                {latexPreview.trim() && (
                                    <div className="mt-3 p-3 border border-blue-200 rounded-lg bg-blue-50">
                                        <p className="text-xs uppercase font-bold text-blue-800 mb-2">LaTeX Preview</p>
                                        <div className="p-3 rounded bg-white border border-blue-100">
                                            <LatexRenderer latex={latexPreview} displayMode={false} />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-between items-center border-t border-stone-200 pt-4">
                        <button onClick={() => setText('')} className="text-rose-600 hover:text-rose-500 text-sm font-medium px-2">Clear All</button>
                        <button onClick={() => copyToClipboard(text, showToast)} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-colors shadow-sm">Copy Result</button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const validTabs = ['equation', 'text'];
            const getTabFromHash = () => {
                const hash = (window.location.hash || '').replace('#', '');
                return validTabs.includes(hash) ? hash : 'equation';
            };

            const [activeTab, setActiveTab] = useState(() => getTabFromHash());
            const [toastMsg, setToastMsg] = useState(null);

            useEffect(() => {
                const syncFromHash = () => {
                    const hashTab = getTabFromHash();
                    setActiveTab((prev) => (hashTab !== prev ? hashTab : prev));
                };
                // Ensure deep-linked tabs like #algorithm show immediately
                syncFromHash();
                window.addEventListener('hashchange', syncFromHash);
                return () => window.removeEventListener('hashchange', syncFromHash);
            }, []);

            useEffect(() => {
                const nextHash = `#${activeTab}`;
                if (window.location.hash !== nextHash) {
                    history.replaceState(null, '', nextHash);
                }
            }, [activeTab]);

            const showToast = (msg) => {
                setToastMsg(msg);
                setTimeout(() => setToastMsg(null), 3000);
            };

            return (
                <div className="min-h-screen flex flex-col font-sans selection:bg-blue-200/50">
                    <header className="bg-white/85 backdrop-blur border-b border-stone-200 sticky top-0 z-50 shadow-sm">
                        <div className="max-w-6xl mx-auto px-4">
                            <div className="flex items-center justify-between h-16">
                                <span className="text-2xl font-semibold text-blue-800 tracking-tight" style={{ fontFamily: 'Literata, serif' }}>
                                    LaTeX Tools
                                </span>
                                <div className="flex items-center gap-3">
                                    <a
                                        href="../index.html"
                                        className="inline-flex items-center gap-2 px-3 py-1.5 rounded-md border border-stone-300 text-sm text-stone-800 bg-white hover:bg-blue-50 transition shadow-sm"
                                    >
                                        <span className="inline-block w-2 h-2 rounded-full bg-blue-500"></span>
                                        Home
                                    </a>
                                    <div className="flex bg-blue-50 rounded-lg p-1 border border-blue-200 shadow-inner flex-wrap gap-1">
                                        <button
                                            onClick={() => setActiveTab('equation')}
                                            className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'equation' ? 'bg-blue-600 text-white shadow-lg' : 'text-blue-800 hover:bg-blue-100'}`}
                                        >
                                            Equation Editor
                                        </button>
                                        <button
                                            onClick={() => setActiveTab('text')}
                                            className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'text' ? 'bg-blue-600 text-white shadow-lg' : 'text-blue-800 hover:bg-blue-100'}`}
                                        >
                                            Text Tools
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-6xl mx-auto w-full p-4 md:p-6 overflow-hidden flex flex-col">
                        {activeTab === 'equation' && <EquationEditor showToast={showToast} />}
                        {activeTab === 'text' && <TextTools showToast={showToast} />}
                    </main>

                    <Toast message={toastMsg} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
